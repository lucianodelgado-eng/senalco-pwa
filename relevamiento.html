<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relevamiento de Alarmas</title>
    <link rel="stylesheet" href="estilo.css" />
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#c10707">
    <script>
        // Verifica si estÃ¡ logueado, si no, redirige al login
        if (localStorage.getItem("logueado") !== "true") {
            window.location.href = "login.html";
        }
    </script>
</head>

<body>
    <img id="logo" src="images/logo.jpg" style="display: none;" />
    <div style="text-align: center; margin-bottom: 10px;">
        <img src="images/logo_blanco.jpg" alt="Logo SeÃ±alco" class="logo-entrada">
    </div>

    <form>
        <h1>Relevamiento</h1>

        <!-- PRIMERA PÃGINA -->
        <div class="seccion">
            <label for="entidad">Entidad</label>
            <input type="text" id="entidad" required />

            <label for="sucursal">Sucursal</label>
            <input type="text" id="sucursal" required />

            <label for="direccion">DirecciÃ³n</label>
            <input type="text" id="direccion" required />

            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" required />

            <label for="remito">Remito</label>
            <input type="text" id="remito" />

            <label for="relevado">Relevado por el tÃ©cnico</label>
            <input type="text" id="relevado" />
        </div>

        <!-- SEGUNDA PÃGINA -->
        <div class="seccion">
            <div id="contenedor-sectores"></div>
            <button type="button" onclick="agregarSector()">Agregar Sector</button>
        </div>

        <!-- NAVEGACIÃ“N -->
        <div class="navegacion">
            <button type="button" id="atras">AtrÃ¡s</button>
            <button type="button" id="siguiente">Siguiente</button>
            <button type="button" id="btn-generar-pdf">Generar PDF</button>
            <button type="button" onclick="borrarFormulario()">Borrar formulario guardado</button>
        </div>
        <div style="margin-top: 20px;">
            <label for="fotos">ðŸ“¸ SubÃ­ tus fotos</label><br>
            <a href="https://drive.google.com/drive/folders/1NXZR2d9FAMhaSio-xZ4JsF-HUEnsrbOR?usp=sharing"
                target="_blank" class="drive-link">
                âž• Subir tus archivos INSTALACIONES/OBRAS <a
                    href="https://drive.google.com/drive/folders/1gnHhmociP3fHu_ecxoa6A7D9ZbnNRnlf?usp=sharing"
                    target="_blank" class="drive-link">
                    âž• Subir tus archivo SERVICE
                </a>
                <p class="drive-note">(AbrirÃ¡ Google Drive crea tu carpeta de tecnico pega tu archivo)</p>
                Â Â Â Â 
        </div>
        <!-- ðŸ“Œ LIBRERÃAS PDF -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>

        <!-- ðŸ“Œ SCRIPT -->
        <script src="relevamiento.js"></script>

        <script>
            const sectoresPrecargados = [
                "SalÃ³n / Cajas",
                "Ãrea Operativa",
                "Banca AutomÃ¡tica / Lobby 24hs",
                "Recinto Tesoro",
                "Recinto Cajas de Seguridad",
                "BÃ³veda de cajas de seguridad",
                "BÃ³veda de tesoro",
                "Bunker / Sala TÃ©cnica"
            ];

            window.addEventListener("DOMContentLoaded", () => {
                const contenedor = document.getElementById("contenedor-sectores");
                const datosGuardados = localStorage.getItem('formularioRelevamiento');

                if (datosGuardados) {
                    const data = JSON.parse(datosGuardados);
                    const tieneDatos = data.sectores?.some(s => s.filas.length > 0);

                    if (tieneDatos) {
                        document.getElementById('entidad').value = data.entidad || '';
                        document.getElementById('sucursal').value = data.sucursal || '';
                        document.getElementById('direccion').value = data.direccion || '';
                        document.getElementById('fecha').value = data.fecha || '';
                        document.getElementById('remito').value = data.remito || '';
                        document.getElementById('relevado').value = data.relevado || '';

                        contenedor.innerHTML = '';
                        data.sectores.forEach(sector => {
                            const div = document.createElement('div');
                            div.className = 'sector';
                            div.innerHTML = `
                                <h3 contenteditable>${sector.nombre}</h3>
                                <table class="tabla-editable">
                                    <thead>
                                        <tr>
                                            <th>Dispositivo</th>
                                            <th>Cantidad</th>
                                            <th>Modelo</th>
                                            <th>Zona(instantanea/24hs)</th>
                                            <th>ObservaciÃ³n de ubicacion</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td data-label="Dispositivo">
                                                <select onchange="mostrarOtro(this)">
                                                    <option value="">-- Seleccionar --</option>
                                                    <option>Equipo de abonado</option>
                                                    <option>Gabinete de Baterias</option>
                                                    <option>Central/Teclados volumetrico</option>
                                                    <option>Teclados</option>
                                                    <option>Pulsadores de asalto</option>
                                                    <option>Pulsadores de Incendio</option>
                                                    <option>Sensores Infrarrojos pasivos</option>
                                                    <option>Sensor Infrarrojo Pasivo Antimasking</option>
                                                    <option>Detectores de humo</option>
                                                    <option>Sirena Interior</option>
                                                    <option>Sirena Exterior</option>
                                                    <option>Receptor InalÃ¡mbrico</option>
                                                    <option>Pulsadores InalÃ¡mbricos</option>
                                                    <option>Pulsador remoto</option>
                                                    <option>Protectores de tesoro</option>
                                                    <option>Sensores SÃ­smicos</option>
                                                    <option>Detectores tÃ©rmicos</option>
                                                    <option>Juegos de magnÃ©ticos</option>
                                                    <option>Magenticos antisabotaje</option>
                                                    <option>Receptor inalÃ¡mbrico</option>
                                                    <option>Cerradura electromagnÃ©tica</option>
                                                    <option>BaterÃ­as</option>
                                                    <option>Otro</option>
                                                </select>
                                                <input type="text" class="otro-dispositivo" style="display:none; margin-top:4px;" placeholder="Especificar otro dispositivo" />
                                            </td>
                                            <td data-label="Cantidad"><input type="number" min="0"></td>
                                            <td data-label="Modelo"><input type="text"></td>
                                            <td data-label="Zona"><input type="text"></td>
                                            <td data-label="ObservaciÃ³n"><input type="text"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div style="margin-top: 10px;">
                                    <button type="button" onclick="guardarFilaEditable(this)">Guardar</button>
                                    <button type="button" onclick="limpiarSector(this)">Limpiar sector</button>
                                    <button type="button" onclick="precargarDispositivos(this, 'atm')">Dispositivos ATM</button>
                                    <button type="button" onclick="precargarDispositivos(this, 'tesoro')">Dispositivos Tesoro</button>
                                    <button type="button" onclick="precargarDispositivos(this, 'CDS')">Dispositivos C. de Seguridad</button>
                                    <button type="button" onclick="precargarDispositivos(this, 'bunker')">Dispositivos Bunker</button>
                                </div>
                                <div class="contador">Dispositivos cargados: <span class="conteo">${sector.filas.length}</span></div>
                                <details class="lista-dispositivos" open>
                                    <summary>Dispositivos completados</summary>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Dispositivo</th>
                                                <th>Cantidad</th>
                                                <th>Modelo</th>
                                                <th>Zona(instantanea/24hs)</th>
                                                <th>ObservaciÃ³n de ubicacion</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${sector.filas.map(fila => `
                                                <tr>
                                                    ${fila.map(val => `<td><input type="text" value="${val}"></td>`).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </details>
                            `;
                            contenedor.appendChild(div);
                        });
                    } else {
                        sectoresPrecargados.forEach(nombre => agregarSectorPorNombre(nombre));
                    }
                } else {
                    sectoresPrecargados.forEach(nombre => agregarSectorPorNombre(nombre));
                }
            });
        </script>

    </form>
    <script>
        function cerrarSesion() {
            localStorage.removeItem("logueado");
            // Evita que el selector se muestre al volver
            window.location.href = "login.html";
        }
    </script>

    <div style="text-align:center; margin-top: 30px;">
        <button onclick="cerrarSesion()" style="padding: 10px 20px; font-size: 16px;">
            ðŸ”’ Cerrar sesiÃ³n
        </button>
    </div>
    <div style="margin-top: 30px;">
        <h3>Relevamientos guardados:</h3>
        <ul id="lista-relevamientos"></ul>
        <button onclick="guardarRelevamientoLocal('relevamientoBorrador1')">ðŸ’¾ Guardar como Borrador 1</button>
        <button onclick="guardarRelevamientoLocal('relevamientoBorrador2')">ðŸ’¾ Guardar como Borrador 2</button>

    </div>

    </script>
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/service-worker.js");
        }
    </script>
</body>

</html>