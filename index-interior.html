<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relevamiento de Alarmas</title>
    <link rel="stylesheet" href="estilo.css" />
    <script>
        // Verifica si est√° logueado, si no, redirige al login
        if (localStorage.getItem("logueado") !== "true") {
            window.location.href = "login.html";
        }
    </script>
</head>

<body>
    <img id="logo" src="images/logo.jpg" style="display: none;" />
    <div style="text-align: center; margin-bottom: 10px;">
        <img src="images/logo_blanco.jpg" alt="Logo Se√±alco" class="logo-entrada">
    </div>

    <form>
        <h1>Relevamiento</h1>

        <!-- PRIMERA P√ÅGINA -->
        <div class="seccion">
            <label for="entidad">Entidad</label>
            <input type="text" id="entidad" required />

            <label for="sucursal">Sucursal</label>
            <input type="text" id="sucursal" required />

            <label for="direccion">Direcci√≥n</label>
            <input type="text" id="direccion" required />

            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" required />

            <label for="remito">Remito</label>
            <input type="text" id="remito" />

            <label for="relevado">Relevado por el t√©cnico</label>
            <input type="text" id="relevado" />
        </div>

        <!-- SEGUNDA P√ÅGINA -->
        <div class="seccion">
            <div id="contenedor-sectores"></div>
            <button type="button" onclick="agregarSector()">Agregar Sector</button>
        </div>

        <!-- NAVEGACI√ìN -->
        <div class="navegacion">
            <button type="button" id="atras">Atr√°s</button>
            <button type="button" id="siguiente">Siguiente</button>
            <button type="button" id="btn-generar-pdf">Generar PDF</button>
            <button type="button" onclick="borrarFormulario()">Borrar formulario guardado</button>
        </div>
        <div style="margin-top: 20px;">
            <label for="fotos">üì∏ Sub√≠ tus fotos</label><br>
            <a href="https://drive.google.com/drive/folders/1xug9oBV5ezG5kWitq7YPRpQzMAlyCks7?usp=sharing"
                target="_blank" class="drive-link">
                ‚ûï Subir tus archivos INSTALACIONES/OBRAS <a
                </a>
                <p class="drive-note">(Abrir√° Google Drive crea tu carpeta de tecnico pega tu archivo)</p>
                ¬†¬†¬†¬†
        </div>
        <!-- üìå LIBRER√çAS PDF -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>

        <!-- üìå SCRIPT -->
        <script src="javas-interior.js"></script>

        <script>
            const sectoresPrecargados = [
                "Sal√≥n / Cajas",
                "√Årea Operativa",
                "Banca Autom√°tica / Lobby 24hs",
                "Recinto Tesoro",
                "Recinto Cajas de Seguridad",
                "B√≥veda de cajas de seguridad",
                "B√≥veda de tesoro",
                "Bunker / Sala T√©cnica"
            ];

            window.addEventListener("DOMContentLoaded", () => {
                const contenedor = document.getElementById("contenedor-sectores");
                const datosGuardados = localStorage.getItem('formularioRelevamiento');

                if (datosGuardados) {
                    const data = JSON.parse(datosGuardados);
                    const tieneDatos = data.sectores?.some(s => s.filas.length > 0);

                    if (tieneDatos) {
                        document.getElementById('entidad').value = data.entidad || '';
                        document.getElementById('sucursal').value = data.sucursal || '';
                        document.getElementById('direccion').value = data.direccion || '';
                        document.getElementById('fecha').value = data.fecha || '';
                        document.getElementById('remito').value = data.remito || '';
                        document.getElementById('relevado').value = data.relevado || '';

                        contenedor.innerHTML = '';
                        data.sectores.forEach(sector => {
                            const div = document.createElement('div');
                            div.className = 'sector';
                            div.innerHTML = `
                                <h3 contenteditable>${sector.nombre}</h3>
                                <table class="tabla-editable">
                                    <thead>
                                        <tr>
                                            <th>Dispositivo</th>
                                            <th>Cantidad</th>
                                            <th>Modelo</th>
                                            <th>Zona(instantanea/24hs)</th>
                                            <th>Observaci√≥n de ubicacion</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td data-label="Dispositivo">
                                                <select onchange="mostrarOtro(this)">
                                                    <option value="">-- Seleccionar --</option>
                                                    <option>Equipo de abonado</option>
                                                    <option>Gabinete de Baterias</option>
                                                    <option>Central/Teclados volumetrico</option>
                                                    <option>Teclados</option>
                                                    <option>Pulsadores de asalto</option>
                                                    <option>Pulsadores de Incendio</option>
                                                    <option>Sensores Infrarrojos pasivos</option>
                                                    <option>Sensor Infrarrojo Pasivo Antimasking</option>
                                                    <option>Detectores de humo</option>
                                                    <option>Sirena Interior</option>
                                                    <option>Sirena Exterior</option>
                                                    <option>Receptor Inal√°mbrico</option>
                                                    <option>Pulsadores Inal√°mbricos</option>
                                                    <option>Pulsador remoto</option>
                                                    <option>Protectores de tesoro</option>
                                                    <option>Sensores S√≠smicos</option>
                                                    <option>Detectores t√©rmicos</option>
                                                    <option>Juegos de magn√©ticos</option>
                                                    <option>Magenticos antisabotaje</option>
                                                    <option>Receptor inal√°mbrico</option>
                                                    <option>Cerradura electromagn√©tica</option>
                                                    <option>Bater√≠as</option>
                                                    <option>Otro</option>
                                                </select>
                                                <input type="text" class="otro-dispositivo" style="display:none; margin-top:4px;" placeholder="Especificar otro dispositivo" />
                                            </td>
                                            <td data-label="Cantidad"><input type="number" min="0"></td>
                                            <td data-label="Modelo"><input type="text"></td>
                                            <td data-label="Zona"><input type="text"></td>
                                            <td data-label="Observaci√≥n"><input type="text"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div style="margin-top: 10px;">
                                    <button type="button" onclick="guardarFilaEditable(this)">Guardar</button>
                                    <button type="button" onclick="limpiarSector(this)">Limpiar sector</button>
                                    <button type="button" onclick="precargarDispositivos(this, 'atm')">Dispositivos ATM</button>
                                    <button type="button" onclick="precargarDispositivos(this, 'tesoro')">Dispositivos Tesoro</button>
                                    <button type="button" onclick="precargarDispositivos(this, 'CDS')">Dispositivos C. de Seguridad</button>
                                    <button type="button" onclick="precargarDispositivos(this, 'bunker')">Dispositivos Bunker</button>
                                </div>
                                <div class="contador">Dispositivos cargados: <span class="conteo">${sector.filas.length}</span></div>
                                <details class="lista-dispositivos" open>
                                    <summary>Dispositivos completados</summary>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Dispositivo</th>
                                                <th>Cantidad</th>
                                                <th>Modelo</th>
                                                <th>Zona(instantanea/24hs)</th>
                                                <th>Observaci√≥n de ubicacion</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${sector.filas.map(fila => `
                                                <tr>
                                                    ${fila.map(val => `<td><input type="text" value="${val}"></td>`).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </details>
                            `;
                            contenedor.appendChild(div);
                        });
                    } else {
                        sectoresPrecargados.forEach(nombre => agregarSectorPorNombre(nombre));
                    }
                } else {
                    sectoresPrecargados.forEach(nombre => agregarSectorPorNombre(nombre));
                }
            });
        </script>

    </form>
    <script>
        function cerrarSesion() {
            localStorage.removeItem("logueado");
            // Evita que el selector se muestre al volver
            window.location.href = "login.html";
        }
    </script>

    <div style="text-align:center; margin-top: 30px;">
        <button onclick="cerrarSesion()" style="padding: 10px 20px; font-size: 16px;">
            üîí Cerrar sesi√≥n
        </button>
    </div>
    <div style="margin-top: 30px;">
        <h3>üìÅ Borradores disponibles</h3>
        <ul id="lista-bases"></ul>
        <button onclick="guardarBorradorBase('borrador1')">üíæ Guardar como Borrador 1</button>
        <button onclick="guardarBorradorBase('borrador2')">üíæ Guardar como Borrador 2</button>
    </div>
    </script>
</body>

</html>